#!/bin/bash

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.
#SCRIPTSCOMMON#

# source debconf library
. /usr/share/debconf/confmodule


# TODO: Fill in this function with the stuff below
kalite_debconf_ask

# Check if there are storage problems and show an error in that case.
db_go || true
db_get ka-lite/download-assessment-items-storage-error
[ "$RET" = "true" ] && ASSESSMENT_ITEMS_STORAGE_ERROR=true || ASSESSMENT_ITEMS_STORAGE_ERROR=false

# There's a storage error, and we cannot download assessment items, instruct
# user about how to download them later.
if $ASSESSMENT_ITEMS_STORAGE_ERROR
then
    db_input high ka-lite/download-assessment-items-storage-error-msg || true
    db_input high ka-lite/download-assessment-items-manual || true
else
    db_input high ka-lite/download-assessment-items || true
    db_go || true
    db_get ka-lite/download-assessment-items
    [ "$RET" = "true" ] && DOWNLOAD_ASSESSMENT_ITEMS=true || DOWNLOAD_ASSESSMENT_ITEMS=false
    
    # If we should download assessment items, ask further questions...
    if $DOWNLOAD_ASSESSMENT_ITEMS
    then
        
        # Where to unpack assessment items
        ASSESSMENT_DIR=""
        
        # Where to fetch assessment items from
        ASSESSMENT_URL=""
        
        # Keep asking for input intil something has been received
        while [ "$ASSESSMENT_DIR" = "" ] || [ "$ASSESSMENT_URL" = "" ]
        do
            db_input high ka-lite/download-assessment-items-url || true
            db_input low ka-lite/assessment-items-dir || true
            db_go || true
            db_get ka-lite/assessment-items-dir
            ASSESSMENT_DIR=$RET
            db_get ka-lite/download-assessment-items-url
            ASSESSMENT_URL=$RET
        done
        
        # If URL is not a local file, ask where to temporarily store it
        if ! [ `echo "$ASSESSMENT_URL" | grep "^file://"` ]
        then
            ASSESSMENT_TMP=""
            while [ "ASSESSMENT_TMP" = "" ]
            do
                db_input low ka-lite/download-assessment-items-tmp
                db_go || true
                db_get ka-lite/download-assessment-items-tmp
                ASSESSMENT_TMP=$RET
            done
        fi
        
        # If the directory already exists from a previous installation
        if [ -d $ASSESSMENT_DIR ]
        then
            version_file=$ASSESSMENT_DIR/assessmentitems.version
            upgrading_assessment_items=false
            if [ -f $version_file ]; then
                old_version="`cat $version_file`"
                [ "$old_version" != "0.15" ] && upgrading_assessment_items=true || upgrading_assessment_items=false
            fi
            
            if $upgrading_assessment_items
            then
                db_input low ka-lite/download-assessment-items-upgrade || true
            else
                if [ -d $ASSESSMENT_DIR ]
                then
                    db_input low ka-lite/download-assessment-items-upgrade || true
                fi
            fi
        fi
    fi
fi

db_go || true

